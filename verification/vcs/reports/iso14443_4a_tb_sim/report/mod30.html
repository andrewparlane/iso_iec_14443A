<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="Author" content="<username>"> <meta name="GENERATOR" content="urg/version [en] (platform name) [urg]">
<title>Unified Coverage Report :: Module :: iso14443_4a_tb</title>
<link type="text/css" rel="stylesheet" href="css/.urg.css">
<link type="text/css" rel="stylesheet" href="css/.layout.css">
<link type="text/css" rel="stylesheet" href="css/.breadcrumb.css">
<script type="text/javascript" src="js/.jquery.js"></script>
<script type="text/javascript" src="js/.jquery-ui.js"></script>
<script type="text/javascript" src="js/.sortable.js"></script>
<script type="text/javascript" src="js/.layout.js"></script>
<script type="text/javascript" src="js/.breadcrumb.js"></script>
<script type="text/javascript">
var layout, westLayout, centerLayout;
$(document).ready(function () {
  if ($("#north-bread-crumb")) {
    $("#north-bread-crumb").jBreadCrumb({easing:'swing'})
  }
  layout = $("body").layout({ 
    resizable: true,
    spacing_open: 4,
    spacing_closed: 4,
    north: {
      size: 76
    },
    south: {
      size: 45,
      initClosed: true
    },
    west: {
      size: 500,
      resizable: true,
      initClosed: false
    }
  });
  centerLayout = $('div.ui-layout-center').layout({
    north__paneSelector: ".ui-layout-center-inner-north",
    center__paneSelector: ".ui-layout-center-inner-center", 
    north__size: 50,
    spacing_open: 4,
    spacing_closed: 4
  });
});
</script>
</head>
<body onLoad="initPage();"><div class="ui-layout-north">
<div class="logo"></div>
<center class="pagetitle">Module Definition</center>
<div align="center"><a href="dashboard.html" ><b>dashboard</b></a> | <a href="hierarchy.html" ><b>hierarchy</b></a> | <a href="modlist.html" ><b>modlist</b></a> | groups | <a href="tests.html" ><b>tests</b></a> | <a href="asserts.html" ><b>asserts</b></a></div>

</div>
<div class="ui-layout-west">
<div name='tag_iso14443_4a_tb'>
<div class=modhdr>
<br clear=all>
<span class=titlename>Module : <a href="#"  onclick="showContent('tag_iso14443_4a_tb')">iso14443_4a_tb</a></span>
<br clear=all>
<table align=left>
<tr class="sortablehead">
<td>SCORE</td><td>LINE</td><td>COND</td><td>TOGGLE</td><td>FSM</td><td>BRANCH</td><td>ASSERT</td></tr><tr>
<td class="s9 cl rt"> 98.21</td>
<td class="s10 cl rt"><a href="mod30.html#Line" >100.00</a></td>
<td class="wht cl rt"></td>
<td class="s9 cl rt"><a href="mod30.html#Toggle" > 92.86</a></td>
<td class="wht cl rt"></td>
<td class="s10 cl rt"><a href="mod30.html#Branch" >100.00</a></td>
<td class="s10 cl rt"><a href="mod30.html#Assert" >100.00</a></td>
</tr></table><br clear=all>
<span class=repname>Source File(s) : </span>
<br clear=all>
<a href="javascript:void(0);"  onclick="openSrcFile('/home/aparlane/fiuba_thesis/hdl/components/iso_iec_14443A/verification/vcs/../../verification/tb/iso14443_4a/iso14443_4a_tb.sv')">/home/aparlane/fiuba_thesis/hdl/components/iso_iec_14443A/verification/vcs/../../verification/tb/iso14443_4a/iso14443_4a_tb.sv</a><br clear=all>
<br clear=all>
<span class=repname>Module self-instances :</span>
<br clear=all>
<table align=left>
<tr class="sortablehead">
<td class="alfsrt">NAME</td><td>SCORE</td><td>LINE</td><td>COND</td><td>TOGGLE</td><td>FSM</td><td>BRANCH</td><td>ASSERT</td></tr><tr>
<td class="wht cl wordwrap"><a href="mod30.html#inst_tag_32"  onclick="showContent('inst_tag_32')">iso14443_4a_tb</a></td>
<td class="s9 cl rt"> 98.21</td>
<td class="s10 cl rt"><a href="mod30.html#Line" >100.00</a></td>
<td class="wht cl rt"></td>
<td class="s9 cl rt"><a href="mod30.html#Toggle" > 92.86</a></td>
<td class="wht cl rt"></td>
<td class="s10 cl rt"><a href="mod30.html#Branch" >100.00</a></td>
<td class="s10 cl rt"><a href="mod30.html#Assert" >100.00</a></td>
</tr></table></div>
</div>
<br clear=all>
<div name='tag_iso14443_4a_tb'>
<hr>
<a name="inst_tag_32"></a>
<div class=modhdr>
<br clear=all>
<span class=titlename>Module Instance : <a href="hierarchy.html#tag_urg_inst_32" >iso14443_4a_tb</a></span>
<br clear=all>
<br clear=all>
<span class=repname>Instance :</span>
<br clear=all>
<table align=left>
<tr class="sortablehead">
<td>SCORE</td><td>LINE</td><td>COND</td><td>TOGGLE</td><td>FSM</td><td>BRANCH</td><td>ASSERT</td></tr><tr>
<td class="s9 cl rt"> 98.21</td>
<td class="s10 cl rt"><a href="mod30.html#Line" >100.00</a></td>
<td class="wht cl rt"></td>
<td class="s9 cl rt"><a href="mod30.html#Toggle" > 92.86</a></td>
<td class="wht cl rt"></td>
<td class="s10 cl rt"><a href="mod30.html#Branch" >100.00</a></td>
<td class="s10 cl rt"><a href="mod30.html#Assert" >100.00</a></td>
</tr></table><br clear=all>
<br clear=all>
<span class=repname>Instance's subtree :</span>
<br clear=all>
<table align=left>
<tr class="sortablehead">
<td>SCORE</td><td>LINE</td><td>COND</td><td>TOGGLE</td><td>FSM</td><td>BRANCH</td><td>ASSERT</td></tr><tr>
<td class="s9 cl rt"> 95.83</td>
<td class="s9 cl rt"> 93.64</td>
<td class="s9 cl rt"> 98.11</td>
<td class="s9 cl rt"> 90.65</td>
<td class="wht cl rt"></td>
<td class="s9 cl rt"> 96.77</td>
<td class="s10 cl rt">100.00</td>
</tr></table><br clear=all>
<br clear=all>
<span class=repname>Parent : </span>
<br clear=all>
<span class=inst>none</span>
<br clear=all>
<br clear=all>
<span class=repname>Subtrees :</span>
<br clear=all>
<table align=left>
<tr class="sortablehead">
<td class="alfsrt">NAME</td><td>SCORE</td><td>LINE</td><td>COND</td><td>TOGGLE</td><td>FSM</td><td>BRANCH</td><td>ASSERT</td></tr><tr>
<td class="wht cl wordwrap"><a href="mod2.html#inst_tag_3" id="tag_urg_inst_3">app_rx_iface</a></td>
<td class="s8 cl rt"> 83.97</td>
<td class="s6 cl rt"> 69.57</td>
<td class="wht cl rt"></td>
<td class="s8 cl rt"> 82.35</td>
<td class="wht cl rt"></td>
<td class="wht cl rt"></td>
<td class="s10 cl rt">100.00</td>
</tr><tr>
<td class="wht cl wordwrap"><a href="mod4.html#inst_tag_6" id="tag_urg_inst_6">app_tx_iface</a></td>
<td class="s8 cl rt"> 87.50</td>
<td class="wht cl rt"></td>
<td class="wht cl rt"></td>
<td class="s7 cl rt"> 75.00</td>
<td class="wht cl rt"></td>
<td class="wht cl rt"></td>
<td class="s10 cl rt">100.00</td>
</tr><tr>
<td class="wht cl wordwrap"><a href="mod28.html#inst_tag_30" id="tag_urg_inst_30">clock_source_inst</a></td>
<td class="s10 cl rt">100.00</td>
<td class="s10 cl rt">100.00</td>
<td class="wht cl rt"></td>
<td class="s10 cl rt">100.00</td>
<td class="wht cl rt"></td>
<td class="wht cl rt"></td>
<td class="wht cl rt"></td>
</tr><tr>
<td class="wht cl wordwrap"><a href="mod24.html#inst_tag_26" id="tag_urg_inst_26">dut</a></td>
<td class="s9 cl rt"> 98.26</td>
<td class="s10 cl rt">100.00</td>
<td class="s9 cl rt"> 98.11</td>
<td class="s9 cl rt"> 98.28</td>
<td class="wht cl rt"></td>
<td class="s9 cl rt"> 96.67</td>
<td class="wht cl rt"></td>
</tr><tr>
<td class="wht cl wordwrap"><a href="mod2.html#inst_tag_2" id="tag_urg_inst_2">rx_iface</a></td>
<td class="s8 cl rt"> 89.86</td>
<td class="s6 cl rt"> 69.57</td>
<td class="wht cl rt"></td>
<td class="s10 cl rt">100.00</td>
<td class="wht cl rt"></td>
<td class="wht cl rt"></td>
<td class="s10 cl rt">100.00</td>
</tr><tr>
<td class="wht cl wordwrap"><a href="mod4.html#inst_tag_5" id="tag_urg_inst_5">tx_iface</a></td>
<td class="s8 cl rt"> 87.50</td>
<td class="wht cl rt"></td>
<td class="wht cl rt"></td>
<td class="s7 cl rt"> 75.00</td>
<td class="wht cl rt"></td>
<td class="wht cl rt"></td>
<td class="s10 cl rt">100.00</td>
</tr></table><br clear=all>
</div>
</div>
<hr>
Since this is the module's only instance, the coverage report is the same as for the module.</div>
<div class="ui-layout-center">
<div class="ui-layout-center-inner-center">
<div name='tag_iso14443_4a_tb'>
<a name="Line"></a>
Line Coverage for Module : <a href="mod30.html" >iso14443_4a_tb</a><br clear=all>
<table class="noborder">
<col width="122">
<col span="4" width="82">
<tr><th></th><th>Line No.</th><th>Total</th><th>Covered</th><th>Percent</th></tr>
<tr class="s10"><td class="lf">TOTAL</td><td></td><td>39</td><td>39</td><td>100.00</td></tr>
<tr class="s10"><td class="lf">ALWAYS</td><td>130</td><td>3</td><td>3</td><td>100.00</td></tr>
<tr class="s10"><td class="lf">INITIAL</td><td>532</td><td>36</td><td>36</td><td>100.00</td></tr>
</table>
<pre class="code"><br clear=all>
129                         always_ff @(posedge rx_iface.data_valid, negedge rst_n) begin
130        1/1                  if (!rst_n) begin
131        1/1                      rx_crc_ok &lt;= 1'b0;
132                             end
133                             else begin
134        1/1                      rx_crc_ok &lt;= set_rx_crc_ok;
135                             end
136                         end
137                     
138                         // ----------------------------------------------------------------
139                         // Extend CommsTestsSequence to do TB specific stuff
140                         // ----------------------------------------------------------------
141                     
142                         logic expect_rx_rats;
143                         logic expect_rx_deselect;
144                         logic expect_app_resend_last;
145                     
146                         class ISO14443_4aTbSequence
147                         extends comms_tests_sequence_pkg::CommsTestsSequence
148                         #(
149                             .RxTransType        (RxInTransType),
150                             .TxTransType        (TxOutTransType),
151                             .RxTransConvType    (RxTransConvType),
152                             .TxTransConvType    (TxTransConvType),
153                             .RxDriverType       (RxDriverType),
154                             .TxMonitorType      (TxMonitorType)
155                         );
156                     
157                             // should we be setting rx_crc_ok?
158                             logic       corrupt_crcs;
159                     
160                             // we need to know if the last sent message was a valid STD I-Block for the DUT.
161                             // Then if an R(ACK/NAK) is sent with the wronge block number we can verify app_resend_last
162                             // and actually resend the last reply from the app.
163                             logic       last_sent_was_valid_std_i_block;
164                     
165                             // To be able to resend the last app response, we need to cache what it was
166                             logic [7:0] app_last_sent_inf [$];
167                     
168                             // constructor
169                             function new(TransGenType               _rx_trans_gen,
170                                          TransGenType               _tx_trans_gen,
171                                          RxTransConvType            _rx_trans_conv,
172                                          TxTransConvType            _tx_trans_conv,
173                                          RxQueueWrapperType         _rx_send_queue,
174                                          TxQueueWrapperType         _tx_recv_queue,
175                                          RxDriverType               _rx_driver,
176                                          TxMonitorType              _tx_monitor,
177                                          int                        _reply_timeout);
178                     
179                                 // UID is not used in part4 comms
180                                 const static uid_pkg::UID dummy_uid = uid_pkg::UID::new_single_uid(32'h0);
181                     
182                                 super.new(dummy_uid,
183                                           _rx_trans_gen,
184                                           _tx_trans_gen,
185                                           _rx_trans_conv,
186                                           _tx_trans_conv,
187                                           _rx_send_queue,
188                                           _tx_recv_queue,
189                                           _rx_driver,
190                                           _tx_monitor,
191                                           _reply_timeout,
192                                           1000);             // TODO: Run optimised builds and test with more than 1000 loops per test
193                     
194                                 corrupt_crcs                    = 1'b0;
195                                 last_sent_was_valid_std_i_block = 1'b0;
196                                 app_last_sent_inf               = '{};
197                             endfunction
198                     
199                             virtual protected task do_reset;
200                                 rst_n &lt;= 1'b0;
201                                 repeat (5) @(posedge clk) begin end
202                                 rst_n &lt;= 1'b1;
203                                 repeat (5) @(posedge clk) begin end
204                             endtask
205                     
206                             function void sequence_callback(EventCode ec, int arg=0);
207                                 case (ec)
208                                     EventCode_SENDING:  begin
209                                         // argument is an EventMessageID
210                                         automatic EventMessageID    mid             = EventMessageID'(arg);
211                                         // sending an Rx message, mark it as CRC OK
212                                         // this isn't perfect as it will only be asserted once all the data
213                                         // and the CRC have been received, but it's good enough for this test.
214                                         // The correct behaviour will be tested in iso14443_3a_tb
215                                         automatic logic set_crc = !corrupt_crcs;
216                     
217                                         //$display(&quot;message: %s&quot;, mid.name);
218                     
219                                         case (mid)
220                                             EventMessageID_REQA:                    set_rx_crc_ok = 1'b0;
221                                             EventMessageID_WUPA:                    set_rx_crc_ok = 1'b0;
222                                             EventMessageID_HLTA:                    set_rx_crc_ok = set_crc;
223                                             EventMessageID_AC:                      set_rx_crc_ok = 1'b0;
224                                             EventMessageID_SELECT:                  set_rx_crc_ok = set_crc;
225                                             EventMessageID_RANDOM_NON_VALID:        set_rx_crc_ok = set_crc;
226                                             EventMessageID_RATS:                    set_rx_crc_ok = set_crc;
227                                             EventMessageID_PPS:                     set_rx_crc_ok = set_crc;
228                                             EventMessageID_STD_S_DESELECT:          set_rx_crc_ok = set_crc;
229                                             EventMessageID_STD_I_BLOCK_CHAINING:    set_rx_crc_ok = set_crc;
230                                             EventMessageID_STD_I_BLOCK_NO_CHAINING: set_rx_crc_ok = set_crc;
231                                             EventMessageID_STD_R_ACK:               set_rx_crc_ok = set_crc;
232                                             EventMessageID_STD_R_NAK:               set_rx_crc_ok = set_crc;
233                                             EventMessageID_STD_S_DESELECT:          set_rx_crc_ok = set_crc;
234                                             EventMessageID_STD_S_PARAMETERS:        set_rx_crc_ok = set_crc;
235                                             default:                                $error(&quot;Handle mid: %s&quot;, mid.name);
236                                         endcase
237                                     end
238                                     EventCode_SENT: begin: ecSent
239                                         // argument is an EventMessageID
240                                         automatic EventMessageID mid = EventMessageID'(arg);
241                                         //$display(&quot;Sent %s&quot;, mid.name);
242                     
243                                         // done, clear the flags
244                                         expect_rx_rats  = 1'b0;
245                                         tag_active      = 1'b0;
246                     
247                                         // clear this here, if we have actually just finished sending a valid STD I-Block
248                                         // then this was called indirectly from the overridden send_std_i_block() below.
249                                         // Once we return to that, we'll set this flag if it were in fact a valid
250                                         // STD I-Block for the PICC.
251                                         last_sent_was_valid_std_i_block = 1'b0;
252                     
253                                         // check that this message was not forwarded to the app
254                                         // except in the case of the STD I-Block message which if valid
255                                         // should be forwarded and is verified in the overriden
256                                         // send_std_i_block task below
257                                         if ((mid != EventMessageID_STD_I_BLOCK_CHAINING) &amp;&amp;
258                                             (mid != EventMessageID_STD_I_BLOCK_NO_CHAINING)) begin
259                                             check_not_forwarded_to_app;
260                                         end
261                                     end
262                                     EventCode_RECEIVED_OK: begin
263                                         // clear flags
264                                         expect_app_resend_last = 1'b0;
265                                     end
266                                     EventCode_RECEIVED_ERROR: begin
267                                         // clear flags
268                                         expect_app_resend_last = 1'b0;
269                                     end
270                                     default: begin
271                                         $error(&quot;Handle event: %s&quot;, ec.name);
272                                     end
273                                 endcase
274                             endfunction
275                     
276                             // we don't check state in this TB. There are only 3 states of interest
277                             // and we verify those by sending invalid messages and checking they are ignored
278                             /* function void specific_target_callback(SpecificTargetEventCode ec, int arg=0);
279                                 if ((ec == SpecificTargetEventCode_ENTERED_STATE) ||
280                                     (ec == SpecificTargetEventCode_REMAINING_IN_STATE)) begin
281                                     automatic State state = State'(arg);
282                                     //$display(&quot;Event Code %s, %s&quot;, ec.name, state.name);
283                                     check_state(state);
284                                 end
285                                 else begin
286                                     $error(&quot;Unknown event code %s&quot;, ec.name);
287                                 end
288                             endfunction */
289                     
290                             function void comms_tests_callback(CommsTestsEventCode ec, int arg=0);
291                                 case (ec)
292                                     CommsTestsEventCode_SET_CORRUPT_CRC: begin
293                                         // since we indicate CRCs are OK with rx_crc_ok we need to note not to do that
294                                         // when we are sending corrupt CRCs
295                                         corrupt_crcs = arg;
296                                     end
297                                     CommsTestsEventCode_SET_DRIVER_ERRORS: begin
298                                     end
299                                     default: begin
300                                         $error(&quot;Unknown event code %s&quot;, ec.name);
301                                     end
302                                 endcase
303                             endfunction
304                     
305                             virtual task send_rats(logic [3:0] fsdi, logic [3:0] cid);
306                                 if (!corrupt_crcs &amp;&amp; !rx_driver.get_add_error &amp;&amp; (cid != 15)) begin
307                                     expect_rx_rats = 1'b1;
308                                 end
309                     
310                                 super.send_rats(fsdi, cid);
311                     
312                                 expect_rx_rats = 1'b0;
313                             endtask
314                     
315                             // override send_std_i_block, and verify that the inf field + CRC are forwarded to the ap
316                             virtual task send_std_i_block(StdBlockAddress addr, logic chaining, logic block_num, logic [7:0] inf [$]);
317                                 super.send_std_i_block(addr, chaining, block_num, inf);
318                     
319                                 if (picc_target.is_for_us(addr) &amp;&amp; !chaining &amp;&amp;
320                                     ((picc_state == State_PROTOCOL_PPS_ALLOWED) ||
321                                      (picc_state == State_PROTOCOL_STD_COMMS))) begin
322                                     // check this was forwarded to the app, and send the reply
323                                     // corrupted CRCs get turned into errors on app_rx_iface
324                                     // errors on rx_iface either get forwarded to app_rx_iface or nothing is
325                                     // forwarded to the app. Depending on where the error occurs.
326                                     if (rx_driver.get_add_error) begin
327                                         check_not_forwarded_to_app_or_has_error;
328                                     end
329                                     else if (corrupt_crcs) begin
330                                         check_forwarded_to_app(inf, 1'b1);
331                                     end
332                                     else begin
333                                         last_sent_was_valid_std_i_block = 1'b1;
334                                         check_forwarded_to_app(inf);
335                                         app_last_sent_inf = get_std_i_reply_inf(inf);
336                                         send_std_i_block_reply(app_last_sent_inf);
337                                     end
338                                 end
339                                 else begin
340                                     // check it wasn't forwarded to the app
341                                     check_not_forwarded_to_app;
342                                 end
343                             endtask
344                     
345                             virtual task send_std_r_ack(StdBlockAddress addr, logic block_num);
346                                 if ((picc_target.get_picc_block_num() == block_num) &amp;&amp;
347                                     last_sent_was_valid_std_i_block) begin
348                     
349                                     // If the PCD receives an R(ACK/NAK) with block num the same as
350                                     // it's current block num, then it should resend it's last reply
351                                     expect_app_resend_last = 1'b1;
352                                 end
353                     
354                                 super.send_std_r_ack(addr, block_num);
355                     
356                                 if (expect_app_resend_last) begin
357                                     // resend the last app message
358                                     send_std_i_block_reply(app_last_sent_inf);
359                                 end
360                             endtask
361                     
362                             virtual task send_std_r_nak(StdBlockAddress addr, logic block_num);
363                                 if ((picc_target.get_picc_block_num() == block_num) &amp;&amp;
364                                     last_sent_was_valid_std_i_block) begin
365                     
366                                     // If the PCD receives an R(ACK/NAK) with block num the same as
367                                     // it's current block num, then it should resend it's last reply
368                                     expect_app_resend_last = 1'b1;
369                                 end
370                     
371                                 super.send_std_r_nak(addr, block_num);
372                     
373                                 if (expect_app_resend_last) begin
374                                     // resend the last app message
375                                     send_std_i_block_reply(app_last_sent_inf);
376                                 end
377                             endtask
378                     
379                             // override send_std_s_deselect_verify_reply to check for the std_deselect signal
380                             virtual task send_std_s_deselect_verify_reply(StdBlockAddress addr);
381                                 expect_rx_deselect = 1'b1;
382                                 super.send_std_s_deselect_verify_reply(addr);
383                                 expect_rx_deselect = 1'b0;
384                             endtask
385                     
386                             // override state transition tasks, as many aren't relevant for just the part4 module
387                             virtual protected task go_to_state_idle;
388                                 do_reset;
389                                 register_state_change(State_IDLE);
390                             endtask
391                     
392                             virtual protected task go_to_state_ready;
393                                 go_to_state_idle;
394                                 register_state_change(State_READY);
395                             endtask
396                     
397                             virtual protected task go_to_state_active;
398                                 go_to_state_ready;
399                     
400                                 // fake the tag_active signal from the initialisation module
401                                 tag_active = 1'b1;
402                                 register_state_change(State_ACTIVE);
403                             endtask
404                     
405                             virtual protected task go_to_state_halt;
406                                 do_reset;
407                                 register_state_change(State_HALT);
408                             endtask
409                     
410                             virtual protected task go_to_state_ready_star;
411                                 go_to_state_halt;
412                                 register_state_change(State_READY_STAR);
413                             endtask
414                     
415                             virtual protected task go_to_state_active_star;
416                                 go_to_state_ready_star;
417                     
418                                 // fake the tag_active signal from the initialisation module
419                                 tag_active = 1'b1;
420                                 register_state_change(State_ACTIVE_STAR);
421                             endtask
422                     
423                             virtual function ByteQueue get_std_i_reply_inf(logic [7:0] inf [$]);
424                                 // respond with +1
425                                 foreach(inf[i]) begin
426                                     inf[i] = inf[i] + 1'd1;
427                                 end
428                                 return inf;
429                             endfunction
430                     
431                             virtual protected function void set_power_input(logic [1:0] _power);
432                                 power = _power;
433                             endfunction
434                     
435                             virtual function logic verify_dut_cid(logic [3:0] expected);
436                                 cidAsExpected:
437                                 assert(dut.our_cid == expected) else $error(&quot;DUT's CID is %d expected %d&quot;, dut.our_cid, expected);
438                                 return dut.our_cid == expected;
439                             endfunction
440                     
441                             virtual task wait_for_app_rx(output ready, output AppRxTransType trans, input logic expect_timeout=1'b0);
442                                 if (!app_rx_monitor.idle) begin
443                                     app_rx_monitor.wait_for_packet_received(128, !expect_timeout);
444                                 end
445                     
446                                 // we don't assert here, the caller should assert if needed
447                     
448                                 ready = 1'b0;
449                                 if (app_rx_recv_queue.size()) begin
450                                     ready = 1'b1;
451                                     trans = app_rx_recv_queue.pop_front;
452                                 end
453                             endtask
454                     
455                             virtual protected function void check_not_forwarded_to_app;
456                                 notForwarded:
457                                 assert (app_rx_monitor.idle &amp;&amp; (app_rx_recv_queue.size() == 0))
458                                     else $error(&quot;Message forwarded to the app when not expected&quot;);
459                     
460                                 if (app_rx_recv_queue.size() != 0) begin
461                                     $display(&quot;INFO: got %s when nothing expected&quot;, app_rx_recv_queue[0].to_string);
462                                     void'(app_rx_recv_queue.pop_front);
463                                 end
464                             endfunction
465                     
466                             virtual protected task check_not_forwarded_to_app_or_has_error;
467                                 automatic logic             ready;
468                                 automatic AppRxTransType    trans;
469                                 wait_for_app_rx(ready, trans, 1'b1);    // allow timeout
470                     
471                                 if (ready) begin
472                                     // don't care about the data, just check there's an error
473                                     void'(verify_forwarded_to_app(trans, '{}, 1'b1));
474                                 end
475                             endtask
476                     
477                             virtual protected task check_forwarded_to_app(logic [7:0] inf [$], logic expect_error=1'b0);
478                                 automatic logic             ready;
479                                 automatic AppRxTransType    trans;
480                                 wait_for_app_rx(ready, trans, 1'b0);
481                     
482                                 forwardedToApp: assert (ready) else $error(&quot;Message not forwarded to the app&quot;);
483                     
484                                 if (ready) begin
485                                     void'(verify_forwarded_to_app(trans, inf, expect_error));
486                                 end
487                             endtask
488                     
489                             virtual protected function logic verify_forwarded_to_app(AppRxTransType trans, logic [7:0] inf [$], logic expect_error=1'b0);
490                                 automatic AppRxTransType    expected = new(inf, 0, expect_error);
491                                 automatic logic             res;
492                     
493                                 // the farwarded message is the inf field plus the CRC of the whole message
494                                 // (including the header which is not forwarded). We don't care about the CRC here
495                                 // so pop it off, unless we're expecting an error in which case don't bother, since
496                                 // we only care about the error flag, and the received data may be less than two bytes
497                                 if (!expect_error) begin
498                                     void'(trans.pop_back());
499                                     void'(trans.pop_back());
500                                 end
501                     
502                                 res = trans.compare(expected);
503                     
504                                 appMsgAsExpected:
505                                 assert (res)
506                                 else $error(&quot;Message forwarded to app not as expected, received %s expected %s&quot;,
507                                             trans.to_string, expected.to_string);
508                     
509                                 return res;
510                             endfunction
511                     
512                             virtual protected task send_std_i_block_reply(logic [7:0] reply_inf [$]);
513                                 // fake a reply to a STD I-block
514                                 automatic AppTxTransType trans = new(reply_inf);
515                                 app_tx_send_queue.push_back(trans);
516                             endtask
517                         endclass
518                     
519                         ISO14443_4aTbSequence seq;
520                     
521                         // --------------------------------------------------------------
522                         // Test stimulus
523                         // --------------------------------------------------------------
524                     
525                         initial begin
526                             automatic transaction_generator_pkg::TransactionGenerator   rx_trans_gen;
527                             automatic transaction_generator_pkg::TransactionGenerator   tx_trans_gen;
528                             automatic RxTransConvType                                   rx_trans_conv;
529                             automatic TxTransConvType                                   tx_trans_conv;
530                             automatic int                                               reply_timeout;
531                     
532        1/1                  rx_driver           = new(rx_iface);
533        1/1                  app_rx_monitor      = new(app_rx_iface);
534        1/1                  app_tx_driver       = new(app_tx_iface, 0, 32, 32);
535        1/1                  tx_monitor          = new(tx_iface);
536        1/1                  tx_sink_driver      = new(tx_iface);
537                     
538        1/1                  rx_send_queue       = new('{});
539        1/1                  tx_recv_queue       = new('{});
540                             // app_tx_send_queue and app_rx_recv_queue are just queues and don't use the wrapper class
541        1/1                  app_rx_recv_queue   = '{};
542        1/1                  app_tx_send_queue   = '{};
543                     
544        1/1                  rx_trans_gen        = new(1'b1);    // Rx messages must have CRCs applied
545        1/1                  tx_trans_gen        = new(1'b0);    // Tx messages will not have CRCs applied
546                     
547        1/1                  rx_trans_conv       = new;
548        1/1                  tx_trans_conv       = new;
549                     
550                             // longest valid reply is a STD I-Block with a max of 10 byte INF.
551                             // and a 2 byte header (PCB + CID). the tx_sink_driver reqs every 16 ticks
552        1/1                  reply_timeout   = 256;
553        1/1                  seq             = new(rx_trans_gen,
554                                                   tx_trans_gen,
555                                                   rx_trans_conv,
556                                                   tx_trans_conv,
557                                                   rx_send_queue,
558                                                   tx_recv_queue,
559                                                   rx_driver,
560                                                   tx_monitor,
561                                                   reply_timeout);
562                     
563        1/1                  rx_driver.start         (rx_send_queue.data);
564        1/1                  app_rx_monitor.start    (app_rx_recv_queue);
565        1/1                  app_tx_driver.start     (app_tx_send_queue);
566        1/1                  tx_monitor.start        (tx_recv_queue.data);
567        1/1                  tx_sink_driver.start    ();
568                     
569        1/1                  power                       = 2'b00;
570        1/1                  tag_active                  = 1'b0;
571        1/1                  set_rx_crc_ok               = 1'b1;
572                     
573        1/1                  expect_rx_rats              = 1'b0;
574        1/1                  expect_rx_deselect          = 1'b0;
575        1/1                  expect_app_resend_last      = 1'b0;
576                     
577                             // reset for 5 ticks
578        1/1                  rst_n &lt;= 1'b0;
579        2/2                  repeat (5) @(posedge clk) begin end
                        REPEAT_FALSE
580        1/1                  rst_n &lt;= 1'b1;
581        2/2                  repeat (5) @(posedge clk) begin end
                        REPEAT_FALSE
582                     
583        1/1                  seq.run_all_part4_tests;
584                     
585        2/2                  repeat (5) @(posedge clk) begin end
                        REPEAT_FALSE
586        1/1                  $stop;
</pre>
<hr>
<a name="Toggle"></a>
Toggle Coverage for Module : <a href="mod30.html" >iso14443_4a_tb</a><br clear=all>
<table align=left class="noborder">
<tr>
<th nowrap width=120></th><th nowrap width=80>Total</th><th nowrap width=80>Covered</th><th nowrap width=80>Percent</th></tr><tr class="s9">
<td>Totals</td>
<td class="rt">13</td>
<td class="rt">12</td>
<td class="rt">92.31 </td>
</tr><tr class="s9">
<td>Total Bits</td>
<td class="rt">28</td>
<td class="rt">26</td>
<td class="rt">92.86 </td>
</tr><tr class="s9">
<td nowrap>Total Bits 0->1</td>
<td class="rt">14</td>
<td class="rt">13</td>
<td class="rt">92.86 </td>
</tr><tr class="s9">
<td nowrap>Total Bits 1->0</td>
<td class="rt">14</td>
<td class="rt">13</td>
<td class="rt">92.86 </td>
</tr></table><br clear=all>
<table align=left class="noborder">
<tr>
<th nowrap width=120></th><th nowrap width=80></th><th nowrap width=80></th><th nowrap width=80></th></tr><tr class="s9">
<td>Signals</td>
<td class="rt">13</td>
<td class="rt">12</td>
<td class="rt">92.31 </td>
</tr><tr class="s9">
<td>Signal Bits</td>
<td class="rt">28</td>
<td class="rt">26</td>
<td class="rt">92.86 </td>
</tr><tr class="s9">
<td nowrap>Signal Bits 0->1</td>
<td class="rt">14</td>
<td class="rt">13</td>
<td class="rt">92.86 </td>
</tr><tr class="s9">
<td nowrap>Signal Bits 1->0</td>
<td class="rt">14</td>
<td class="rt">13</td>
<td class="rt">92.86 </td>
</tr></table><br clear=all>
<table align=left class="sortable noborder">
<caption><b>Signal Details</b></caption>
<tr class="sortablehead">
<td class="alfsrt">Name</td><td class="alfsrt">Toggle</td><td class="alfsrt">Toggle 1->0</td><td class="alfsrt">Toggle 0->1</td></tr><tr>
<td>clk</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
</tr><tr>
<td>rst_n</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
</tr><tr>
<td>power[1:0]</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
</tr><tr>
<td>rx_crc_ok</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
</tr><tr>
<td>tx_append_crc</td>
<td class="s3 cl">No</td>
<td class="s3 cl">No</td>
<td class="s3 cl">No</td>
</tr><tr>
<td>tag_active</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
</tr><tr>
<td>rx_rats</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
</tr><tr>
<td>rx_deselect</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
</tr><tr>
<td>app_resend_last</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
</tr><tr>
<td>set_rx_crc_ok</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
</tr><tr>
<td>expect_rx_rats</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
</tr><tr>
<td>expect_rx_deselect</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
</tr><tr>
<td>expect_app_resend_last</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
<td class="s9 cl">Yes</td>
</tr></table><br clear=all>
<hr>
<a name="Branch"></a>
Branch Coverage for Module : <a href="mod30.html" >iso14443_4a_tb</a><br clear=all>
<table align=left class="noborder">
<tr>
<th nowrap width=120></th><th nowrap width=80>Line No.</th><th nowrap width=80>Total</th><th nowrap width=80>Covered</th><th nowrap width=80>Percent</th></tr><tr class="s10">
<td>Branches</td>
<td></td>
<td class="rt">2</td>
<td class="rt">2</td>
<td class="rt">100.00</td>
</tr><tr class="s10">
<td>IF</td>
<td class="rt">130</td>
<td class="rt">2</td>
<td class="rt">2</td>
<td class="rt">100.00</td>
</tr></table><br clear=all>
<pre class="code"><br clear=all>
130                if (!rst_n) begin
                   <font color = "green">-1-</font>  
131                    rx_crc_ok <= 1'b0;
           <font color = "green">            ==></font>
132                end
133                else begin
134                    rx_crc_ok <= set_rx_crc_ok;
           <font color = "green">            ==></font>
</pre>
<br clear=all>
<span class=repname>Branches:</span>
<br clear=all>
<table align=left class="noborder">
<tr>
<th nowrap width=80>-1-</th><th nowrap width=80>Status</th></tr><tr class="uGreen">
<td align=center>1</td>
<td>Covered</td>
</tr><tr class="uGreen">
<td align=center>0</td>
<td>Covered</td>
</tr></table><br clear=all>
<hr>
<a name="Assert"></a>
Assert Coverage for Module : <a href="mod30.html" >iso14443_4a_tb</a><br clear=all>
<table align=left class="noborder">
<tr>
<th nowrap width=120></th><th nowrap width=80>Total</th><th nowrap width=80>Attempted</th><th nowrap width=80>Percent</th><th nowrap width=80>Succeeded/Matched</th><th nowrap width=80>Percent</th></tr><tr>
<td class="wht cl"><a href="#1334116867" >Assertions</a></td>
<td class="wht cl rt">15</td>
<td class="s10 cl rt">15</td>
<td class="s10 cl rt">100.00</td>
<td class="s10 cl rt">15</td>
<td class="s10 cl rt">100.00</td>
</tr><tr>
<td class="wht cl"><a href="#36157144" >Cover properties</a></td>
<td class="wht cl rt">0</td>
<td class="wht cl rt">0</td>
<td class="wht cl"></td>
<td class="wht cl rt">0</td>
<td class="wht cl"></td>
</tr><tr>
<td class="wht cl"><a href="#794098173" >Cover sequences</a></td>
<td class="wht cl rt">0</td>
<td class="wht cl rt">0</td>
<td class="wht cl"></td>
<td class="wht cl rt">0</td>
<td class="wht cl"></td>
</tr><tr>
<td class="wht cl"><b>Total</b></td>
<td class="wht cl rt">15</td>
<td class="s10 cl rt">15</td>
<td class="s10 cl rt">100.00</td>
<td class="s10 cl rt">15</td>
<td class="s10 cl rt">100.00</td>
</tr></table><br clear=all>
<br clear=all>
<hr>
<br clear=all>
<a name="1334116867"></a>
<b>Assertion Details</b><br clear=all>
<br clear=all>
<table align=left class="sortable noborder">
<tr class="sortablehead">
<td class="alfsrt">Name</td><td>Attempts</td><td>Real Successes</td><td>Failures</td><td>Incomplete</td></tr><tr>
<td class="wht cl"><a name="1580060053"></a>
\ISO14443_4aTbSequence::check_forwarded_to_app .forwardedToApp</td>
<td class="s9 cl rt">15563</td>
<td class="s9 cl rt">15563</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="1328387248"></a>
\ISO14443_4aTbSequence::check_not_forwarded_to_app .notForwarded</td>
<td class="s9 cl rt">206240</td>
<td class="s9 cl rt">206240</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="175708840"></a>
\ISO14443_4aTbSequence::verify_dut_cid .cidAsExpected</td>
<td class="s9 cl rt">83806</td>
<td class="s9 cl rt">83806</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="621966720"></a>
\ISO14443_4aTbSequence::verify_forwarded_to_app .appMsgAsExpected</td>
<td class="s9 cl rt">20877</td>
<td class="s9 cl rt">20877</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="2144752819"></a>
appResendLastOneTick</td>
<td class="s9 cl rt">36034677</td>
<td class="s9 cl rt">2990</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="819892210"></a>
appResendLastOnlyWhenExpected</td>
<td class="s9 cl rt">36034677</td>
<td class="s9 cl rt">2990</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="737478402"></a>
appResendLastWhenExpected</td>
<td class="s9 cl rt">36034677</td>
<td class="s9 cl rt">2990</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="349367025"></a>
dataBitsAlways0</td>
<td class="s9 cl rt">36034677</td>
<td class="s9 cl rt">36034677</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="1454288904"></a>
inReset</td>
<td class="s9 cl rt">36034677</td>
<td class="s9 cl rt">385020</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="1452583606"></a>
rxDeselectDuringTx</td>
<td class="s9 cl rt">36034677</td>
<td class="s9 cl rt">4000</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="1989309794"></a>
rxDeselectOneTick</td>
<td class="s9 cl rt">36034677</td>
<td class="s9 cl rt">4000</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="1818551677"></a>
rxDeselectOnlyWhenExpected</td>
<td class="s9 cl rt">36034677</td>
<td class="s9 cl rt">4000</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="359804151"></a>
rxDeselectWhenExpected</td>
<td class="s9 cl rt">36034677</td>
<td class="s9 cl rt">4000</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="454788696"></a>
rxRatsWhenExpected</td>
<td class="s9 cl rt">36034677</td>
<td class="s9 cl rt">228004</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr><tr>
<td class="wht cl"><a name="787775020"></a>
txAppendCRC</td>
<td class="s9 cl rt">36034677</td>
<td class="s9 cl rt">36034677</td>
<td class="s9 cl rt">0</td>
<td class="wht cl rt">0</td>
</tr></table><br clear=all>
</div>
</div>
<div class="ui-layout-center-inner-north">
<div id="center-bread-crumb" class="breadCrumb module urg-margin-bottom">
  <ul name="inst_tag_32">
    <li>
      <a href="#Line">Line</a>    </li>
    <li>
      <a href="#Toggle">Toggle</a>    </li>
    <li>
      <a href="#Branch">Branch</a>    </li>
    <li>
      <a href="#Assert">Assert</a>    </li>
  </ul>
  <ul name="tag_iso14443_4a_tb">
    <li>
      <a href="#Line">Line</a>    </li>
    <li>
      <a href="#Toggle">Toggle</a>    </li>
    <li>
      <a href="#Branch">Branch</a>    </li>
    <li>
      <a href="#Assert">Assert</a>    </li>
  </ul>
</div>
</div>
</div>
<div class="ui-layout-south">
<table align=center><tr><td class="s0 cl">0%</td>
<td class="s1 cl">10%</td>
<td class="s2 cl">20%</td>
<td class="s3 cl">30%</td>
<td class="s4 cl">40%</td>
<td class="s5 cl">50%</td>
<td class="s6 cl">60%</td>
<td class="s7 cl">70%</td>
<td class="s8 cl">80%</td>
<td class="s9 cl">90%</td>
<td class="s10 cl">100%</td></tr></table></div>
</body>
</html>
